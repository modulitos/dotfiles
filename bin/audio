#!/bin/bash

readarray -t SINKS < <(pactl list short sinks | awk '$7 == "RUNNING"{ print $1 }')

# printf 'sinks!: %s\n' "${SINKS[@]}"


# echo "SINK: $SINK"

# getdefaultsinkname() {
#     pacmd stat | awk -F": " '/^Default sink name: /{print $2}'
# }

# getdefaultsinkvol() {
#     pacmd list-sinks |
#         awk '/^\s+name: /{indefault = $2 == "<'$(getdefaultsinkname)'>"}
#             /^\s+volume: / && indefault {print $5; exit}'
# }


case $1 in
  mute|m)
    for sink in "${SINKS[@]}"; do
      pactl set-sink-mute "$sink" toggle
    done
    ;;
  play|pause|p)
    dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.PlayPause
    ;;
  stop|s)
    dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Stop
    ;;
  forward|f)
    dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Next
    ;;
  back|b)
    dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.Previous
    ;;
  increase|i)
    # TODO: make the sinks to start at the same volume?
    for sink in "${SINKS[@]}"; do
      echo "adjusting sink volume: $sink"
      pactl set-sink-volume "$sink" +5000
    done
    ;;
  current|c)
    for sink in "${SINKS[@]}"; do
      # pactl list sinks | grep '^[[:space:]]Volume:' | head -n $(( "$sink" + 1 )) | tail -n 1 | sed -e 's,.* \([0-9][0-9]*\)%.*,\1,'
      VOLUME_INFO=$(pactl list sinks | grep "Sink #$sink" -A 10 | grep '^[[:space:]]Volume:')
      DESCRIPTION=$(pactl list sinks | grep "Sink #$sink" -A 10 | grep '^[[:space:]]Description:')
      printf "sink $sink:\n%s\n%s\n" "$DESCRIPTION" "$VOLUME_INFO"
    done
    ;;
  decrease|d)
    for sink in "${SINKS[@]}"; do
      echo "adjusting sink volume: $sink"
      pactl set-sink-volume "$sink" -5000
    done
    ;;
  *)
    echo "Invalid input."
    echo "Valid inputs are:"
    echo ""
    echo "increase|i"
    echo "decrease|d"
    echo "play|pause|p"
    echo "stop|s"
    echo "forward|f"
    echo "back|b"
    echo "mute|m"
    echo "current|c"
    echo ""
    echo "goodbye!"
    ;;
esac
